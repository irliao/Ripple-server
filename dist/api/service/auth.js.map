{"version":3,"sources":["src/api/service/auth.js"],"names":[],"mappings":"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","file":"src/api/service/auth.js","sourcesContent":["var jwt = require('jsonwebtoken');\nvar nconf = require('nconf');\nvar uuid = require('node-uuid');\nvar LOG = require('../service/util').logger;\nvar validator = require('../service/util').validator;\nvar crypto = require('crypto'),\n  algorithm = 'aes-256-ctr',// update to encryption with GCM later\n  key = nconf.get('secret-key')['encription'];\n\nvar encrypt =function (text) {/*\n    //var iv = new Buffer(crypto.randomBytes(12)); // ensure that the IV (initialization vector) is random\n    var cipher = crypto.createCipher(algorithm, key);//crypto.createDecipheriv(algorithm, key, iv);\n    LOG.info('text');\n    LOG.info(text);\n    var encrypted = cipher.update(text, 'utf8', 'hex');\n    encrypted += cipher.final('hex');\n    LOG.info(cipher);\n    LOG.info('encrypted');\n    LOG.info(encrypted);\n    //var tag = cipher.getAuthTag();\n    return encrypted//+'$'+ tag+'$'+ iv.toString('hex')\n    */\n   return text\n};\nmodule.exports.encrypt = encrypt;\n\nvar decrypt =  function (encrypted) {/*\n    LOG.info('encrypted');\n    LOG.info(encrypted);\n    //var blob = encrypted.spilt('$');\n    //var iv = new Buffer(blob[2], 'hex');\n    var decipher = crypto.createDecipher(algorithm, key);\n    //decipher.setAuthTag(blob[1]);\n    var dec = decipher.update(encrypted, 'hex', 'utf8')\n    dec += decipher.final('utf8');\n    return dec;\n    */\n   return encrypted\n};\nmodule.exports.decrypt = decrypt;\n\nvar signToken =  function( type, payload)\n{\n    var token = jwt.sign(payload, nconf.get('secret-key')['token'][type] );\n    return token;\n};\nmodule.exports.signToken = signToken;\nvar verifyToken = function(type, token, verified) {\n  return jwt.verify(token, nconf.get('secret-key')['token'][type] , {}, verified);\n};\nmodule.exports.verifyToken = verifyToken;\n\nmodule.exports.verifySecret = function( secret, key, res, next) {\n  req['action_token'] = decript(secret);\n  LOG.info('secrete')\n  LOG.info(req['secret'])\n\n};\n\nmodule.exports.newAuthToken = function(token, renewAid, next)\n{\n    var actor_id = (renewAid)? uuid.v4(): token.actor_id;\n    var token =  signToken('auth',\n    {\n        device_id : token.device_id,\n        actor_id: actor_id || '',\n        lat:token.lat || 0,\n        lon:token.lon || 0\n    });\n    next(token);\n};\n\nmodule.exports.registerOrAuth = function( req, res, next )\n{\n    var token = req.body.auth_token || '';\n    LOG.info('body::');\n    LOG.info( req.body);\n    LOG.info('body::');\n    if( token === 'new' )\n    {\n        req.body.auth_token = 'new';\n        LOG.info('innnnbody::');\n\n        next();\n    }\n    else\n    {\n        verifyToken('auth',token, function( err, payload)\n        {\n            if(err)\n            {\n                res.status(401).json( { err:err } );\n            }else\n            {\n                LOG.info('verify auth_token:');\n                LOG.info( payload);\n                req.body.auth_token = payload;\n                next();\n            }\n        });\n    }\n\n};\nmodule.exports.authenticate = function( req, res, next )\n{\n    var token = req.body.auth_token || '';\n\n    verifyToken('auth',token, function( err, payload)\n    {\n        if(err || typeof payload.device_id !== 'string' )\n        {\n            res.status(401).json( { err:err } );\n        }else\n        {\n            LOG.info('verify auth_token:');\n            LOG.info( payload);\n            req.body.auth_token = payload;\n            LOG.info( req.body.auth_token);\n            next();\n        }\n    });\n};\n\nmodule.exports.parseAction = function( req, res, next)\n{\n    var token = req.body.action_token || '';\n    var secret = JSON.parse(JSON.parse(decrypt(token)));\n    LOG.info( '....res.body');\n    LOG.info( secret);\n    req.body.action_token = secret;\n    next();\n\n}\n\nmodule.exports.issueActionToken = function( action, secrets, next)\n{\n    LOG.info( 'auth  issue action token');\n    LOG.info( secrets);\n\n    var tasks = {\n        like: function(next)\n        {\n            secrets.action = 'like';\n            var token = encrypt(JSON.stringify(JSON.stringify(secrets)));\n\n\n            next( token );\n        },\n        subscribe: function(next)\n        {\n            secrets.action = 'subscribe';\n            var token = encrypt(JSON.stringify(JSON.stringify(secrets)));\n\n\n            next( token );\n        },\n        connect: function(next)\n        {\n            var secret = encrypt(JSON.stringify(JSON.stringify(secrets)));\n            var token = signToken('action',\n                {\n                    action : 'connect',\n                    encrypted: secret\n                });\n            next(token);\n        }\n    };\n\n    tasks[action](next);\n}"]}