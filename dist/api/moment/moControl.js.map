{"version":3,"sources":["src/api/moment/moControl.js"],"names":[],"mappings":"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","file":"src/api/moment/moControl.js","sourcesContent":["var MOMENT = require('./moModel');\nvar S3 = require('../service/uploader');\nvar PUBNUB = require('../service/pubnub');\nvar LOG = require('../service/util').logger;\nvar mongoose     = require( 'mongoose' );\nvar CHALK =  require('chalk');\nvar async = require('async');\nvar time = require('moment');\nvar uuid = require('node-uuid');\nvar AUTH = require('../service/auth');\nvar DEVICE = require('../device/deModel');\nvar ACTOR = require('../actor');\n/*\n*   Upload photo and create a temporary moment\n*/\nexports.initMoment = function( params, response )\n{\n    LOG.info( CHALK.red('In MOMENT.init') );\n    console.log( params);\n    var device = params.resource_device;\n    var actor_id = uuid.v4();\n    var newActor = new ACTOR(\n    {\n         actor_id :      actor_id,\n         device_id :     device.device_id,\n         pubnub_key :    device.pubnub_key,\n         image_url:      params.image_url,\n         health: \"established\",\n    });\n    AUTH.newAuthToken( {device_id:device.device_id, actor_id:actor_id, lat:params.lat,lon:params.lon}, false,\n                        function ( newToken )\n                        {\n                            response(202, '', newToken);\n                        });\n    MOMENT.getExplore( params,\n        function saveExploreList( err, explore_list)\n        {\n            LOG.info( CHALK.red('In MOMENT.init end') );\n            newActor.explore = explore_list || [];\n            newActor.save(function (err){LOG.error('eruuuuur');LOG.error(err);});\n        });\n\n};\n\n\nexports.completeMoment = function(params,response)\n{\n    var actor = params.resource_actor;\n    //actor found, is moment also found and fresh?\n    if(actor)\n    {\n        if(actor.health === 'established')\n        {\n            //create moment\n            LOG.info('completin')\n            var mo = new MOMENT({\n                actor_id:       actor.actor_id,\n                device_id :     actor.device_id,\n                image_url :     actor.image_url,\n                status:         params.status,\n                pubnub_key:     actor.pubnub_key,\n                location: [parseFloat(params.lat), parseFloat(params.lon)]\n            });\n            mo.save(function (err){LOG.error('eruuuuur');LOG.error(err);});\n            DEVICE.notifySubscriber(mo);\n            // is there duplicates?\n            // no\n            actor.health = 'completed';\n            actor.status = params.status;\n            actor.save();\n            response(201, '', actor.explore);\n        }\n        else if(actor.health === 'completed')\n        {\n            response(304,  '', actor.explore);\n        }\n        else if(['pending', 'badimage'].indexOf(actor.health))\n        {\n           response(304,  '', actor.explore);\n        }\n    }\n    else\n    {\n        response(404,  'not found', []);\n\n    }\n\n};\n\n\n\nexports.getNewExplore = function( params, next )\n{\n\n    MOMENT.getExplore( params,\n        function ( err, explore_list)\n        {\n            LOG.info('@@@@@@@@@@@@@@@@@@');\n            LOG.info(explore_list);\n            next(200, explore_list);\n        });\n};\n\n\n\n\n\nvar actionMenu = {\n        /*\n        *   Check if a like relation with the target is already place in your relations\n        *   if yes, create the connection. Otherwise, place a like relation in the target's relations\n        */\n        like: function(params, next)\n        {\n\n            LOG.info(params.action_token);\n            var target_aid = params.action_token.target_info.aid;\n            ACTOR.getRelation(target_aid, params.auth_token.actor_id,function (err,actor)\n            {\n                console.log('-------actor[0]');\n                console.log(actor[0]);\n                if(err || !actor[0])\n                {\n                    LOG.info(err);\n                    next(404,err);\n                }\n                else if(actor[0].health === 'completed')\n                {\n                    if(actor[0].relation[0] && actor[0].relation[0].actor_id === target_aid)\n                    {\n                        if(!actor[0].connection[0] && actor[0].relation[0].status === 0)\n                        {\n                            PUBNUB.createConversation( actor.pubnub_key, actor[0].relation[0].pubnub_key,\n                            function addConnections( channel_id )\n                            {\n                                ACTOR.saveRemoteConnection({own_device_id:params.auth_token.device_id,owner_aid:params.auth_token.actor_id, target_aid:target_aid,type:'like', channel_id:channel_id},\n                                    function(err, device_id)\n                                    {\n                                        LOG.info('device_id');LOG.info(device_id);\n\n                                        actor[0].saveConnection({target_device_id:device_id,target_aid:target_aid,type:'like', channel_id:channel_id});\n                                        PUBNUB.notifyRemote(\n                                            {\n                                                type                : 'like',\n                                                explore_id          : actor[0].relation[0].actor_id,\n                                                chat_channel_id     : channel_id,\n                                                server_channel_id   : device_id,\n                                            },function(){});\n                                            next(202,{\n                                                channel_id:channel_id,\n                                            },'liked by target');\n\n                                    });\n                            });\n                        }\n                        else if(!actor[0].connection[0] && actor[0].relation[0].status === 1)\n                        {\n                            next(200,'already liked target');\n                        }\n                        else if(actor[0].connection[0]  )\n                        {\n                            next(200,'already friends');\n                        }\n                    }\n                    else\n                    {\n                        actor[0].addRelation({target_aid:target_aid,type:'like', status:1});\n\n                        LOG.info('self');LOG.info(actor[0]);LOG.info('target');LOG.info(target_aid);\n                        ACTOR.addRemoteRelation({\n                            target_aid:target_aid,\n                            pubnub_key:actor[0].pubnub_key,\n                            owner_aid:params.auth_token.actor_id,\n                            status:0, type:'like'\n                        });\n                        next(201,'init like');\n                    }\n\n                }\n                else\n                {\n                    next(403, '');\n                }\n            });\n\n        },\n\n        subscribe: function(params, next){\n\n            DEVICE.addSubscriber(\n                params.action_token.target_info,\n                params.auth_token.device_id,\n                params.body.nickname || '',\n                function(err){\n                    next(200,{});\n                });\n        }\n    };\n\nexports.doAction = function( params,  next )\n{\n    LOG.info(params);\n    actionMenu[params.action_token.action](params, next);\n}\n"]}