{"version":3,"sources":["src/api/device/deModel.js"],"names":[],"mappings":";;AAAA,IAAI,QAAQ,GAAU,OAAO,CAAC,UAAU,CAAC,CAAC;AAC1C,IAAI,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC;AAC7B,IAAI,MAAM,GAAM,OAAO,CAAC,mBAAmB,CAAC,CAAC;AAC7C,IAAI,MAAM,GAAG,OAAO,CAAC,mBAAmB,CAAC,CAAC;AAC1C,IAAI,GAAG,GAAG,OAAO,CAAC,iBAAiB,CAAC,CAAC,MAAM,CAAC,CAAC;;AAE7C,IAAI,MAAM,GAAY,QAAQ,CAAC,MAAM,CAAC;;AAGtC,IAAI,YAAY,GAAG,IAAI,MAAM,CACzB;AACI,aAAS,EAAC,MAAM;AAChB,cAAU,EAAC,MAAM;AACjB,aAAS,EAAC,MAAM;AAChB,WAAO,EAAC,CAAC;AACL,iBAAS,EAAC,MAAM;AAChB,cAAM,EAAC,MAAM;AACb,iBAAS,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,WAAS,IAAI,CAAC,GAAG,EAAE,EAC/C,CAAC;AACF,aAAS,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,WAAS,IAAI,CAAC,GAAG,EAAE,EAC/C,EAAE,EAAE,GAAG,EAAE,KAAK,EAAC,CAAC,CAAC;;AAEtB,IAAI,UAAU,GAAG,IAAI,MAAM,CACvB;AACI,cAAU,EAAC,MAAM;AACjB,aAAS,EAAC,MAAM;AAChB,WAAO,EAAC,CAAC;AACL,iBAAS,EAAC,MAAM;AAChB,cAAM,EAAC,MAAM;AACb,iBAAS,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,WAAS,IAAI,CAAC,GAAG,EAAE,EAC/C,CAAC;AACF,aAAS,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,WAAS,IAAI,CAAC,GAAG,EAAE,EAC/C,EAAE,EAAE,GAAG,EAAE,KAAK,EAAC,CAAC,CAAC;;AAEtB,IAAI,UAAU,GAAG,IAAI,MAAM,CACvB;AACI,cAAU,EAAC,MAAM;AACjB,QAAI,EAAC,MAAM,EACd,EAAE,EAAE,GAAG,EAAE,KAAK,EAAC,CAAC,CAAC;;AAEtB,IAAI,YAAY,GAAK,IAAI,MAAM,CAC3B;AACI,aAAS,EAAE,MAAM;AACjB,gBAAY,EAAE,MAAM;AACpB,cAAU,EAAE,MAAM;AAClB,WAAO,EAAE,CAAC,MAAM,CAAC,MAAM,CAAC;AACxB,WAAO,EAAE,CAAC,YAAY,CAAC;AACvB,cAAU,EAAC,CAAC,UAAU,CAAC;AACvB,QAAI,EAAE,CAAC,UAAU,CAAC;AAClB,aAAS,EAAS,EAAE,IAAI,EAAE,IAAI,EAAE,WAAS,IAAI,CAAC,GAAG,EAAE;CACtD,CAAC,CAAC;;;;;AAKP,YAAY,CAAC,OAAO,CAAC,SAAS,GAAG,UAAU,GAAG,EAAE,GAAG,EAAE,IAAI,EACzD;AACI,OAAG,CAAC,IAAI,CAAC,0BAA0B,CAAC,CAAC;AACrC,OAAG,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;AAC9B,OAAG,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;;AAExC,YAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,OAAO,CAC5B;AACG,mBAAc,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,SAAS;KAC7C,EACD,UAAW,GAAG,EAAE,MAAM,EAClB;AACI,YAAG,GAAG,EACN;AACI,eAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAC,GAAG,EAAC,GAAG,EAAC,CAAC,CAAC;SACnC,MAAI;AACD,eAAG,CAAC,IAAI,CAAC,eAAe,GAAG,MAAM,CAAC;AAClC,gBAAI,EAAE,CAAC;SACV;KAEJ,CAAC,CAAC;CACd,CAAC;AACF,YAAY,CAAC,OAAO,CAAC,aAAa,GAAG,UAAS,MAAM,EAAE,qBAAqB,EAAE,QAAQ,EAAC,IAAI,EAAC;;AAGlF,YAAQ,CAAC,KAAK,CAAE,QAAQ,CAAE,CAAC,MAAM,CAC9B;AACG,mBAAa,MAAM,CAAC,GAAG;KACzB,EACD;AACI,iBAAS,EACT;AACI,gBAAI,EACJ;AACI,4BAAe,qBAAqB;AACpC,sBAAe,MAAM,CAAC,IAAI;aAC7B;SACJ;KACJ,EACD,UAAS,GAAG,EAAC,GAAG,EAAE,GAAG,EAAC;AAClB,YAAG,IAAI,EAAE,IAAI,CAAE,GAAG,EAAE,GAAG,EAAE,GAAG,CAAE,CAAC;AAC/B,WAAG,CAAC,KAAK,CAAC,yEAAyE,CAAC,CAAC;AACzE,WAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACd,WAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACd,WAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;KAC7B,CAAC,CAAC;CACd,CAAA;AACD,YAAY,CAAC,OAAO,CAAC,gBAAgB,GAAG,UAAS,EAAE,EAAC;AAChD,WAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;AAChC,YAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,IAAI,CAC7B;AACI,mBAAY,EAAE,CAAC,SAAS;KAC3B,EAAC;AACE,cAAO,CAAC;KACX,EAAC,UAAC,GAAG,EAAE,IAAI,EAAG;AACX,eAAO,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;AAC5B,eAAO,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;AAChB,eAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;AACrB,eAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;;AAE1B,aAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,EAAC,UAAC,CAAC,EAAE,QAAQ,EAAG;AACnC,mBAAO,CAAC,GAAG,CAAC,sBAAsB,CAAC,CAAC;AACpC,mBAAO,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;AACf,kBAAM,CAAC,YAAY,CAAC;AAChB,oBAAI,EAAC,cAAc;AACnB,iCAAiB,EAAC,CAAC,CAAC,UAAU;AAC9B,oBAAI,EAAC,CAAC,CAAC,IAAI;AACX,yBAAS,EAAC,EAAE,CAAC,SAAS;AACtB,sBAAM,EAAE,EAAE,CAAC,MAAM;aACpB,CAAC,CAAC;SAEN,CAAC,CAAC;KAEN,CAAC,CAAC;CACN,CAAA;AACD,YAAY,CAAC,OAAO,CAAC,UAAU,GAAG,UAAU,GAAG,EAAE,MAAM,EACvD;AACI,YAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,OAAO,CAC5B;AACG,mBAAc,GAAG,EACnB,EACD,UAAW,GAAG,EAAE,MAAM,EACtB;AACI,cAAM,CAAC,MAAM,CACT;AACI,qBAAS,EACT;AACI,uBAAO,EAAG,MAAM;aACnB;SACJ,CAAC,CAAC;KACV,CAAC,CAAC;CACV,CAAC;;AAEF,YAAY,CAAC,OAAO,CAAC,aAAa,GAAG,UAAS,MAAM,EAAE,IAAI,EAC1D;AACI,SAAK,CAAC,MAAM,CAAC,MAAM,CAAC,OAAO,EAAE,UAAS,MAAM,EACpC;AACI,eAAO,AAAC,MAAM,GAAE,EAAE,GAAE;AACZ,qBAAS,EAAE,MAAM,CAAC,SAAS;AAC3B,sBAAU,EAAG,MAAM,CAAC,UAAU;AAC9B,mBAAO,EAAG,MAAM,CAAC,OAAO;AACxB,qBAAS,EAAE,MAAM,CAAC,SAAS,EAC9B,CAAA;KACR,EACD,UAAS,WAAW,EACpB;;AAEI,YAAI,EAAE,CAAC;KACV,CAAC,CAAC;CACd,CAAC;;AAEF,YAAY,CAAC,OAAO,CAAC,gBAAgB,GAAG,UAAS,IAAI,EACrD;AACI,WAAO,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;CAC1B,CAAC;;AAGF,YAAY,CAAC,KAAK,CAAC,EAAC,aAAa,EAAC,CAAC,EAAC,CAAC,CAAC;AACtC,YAAY,CAAC,KAAK,CAAC,EAAC,aAAa,EAAC,CAAC,EAAE,qBAAqB,EAAC,CAAC,EAAC,CAAC,CAAC;AAC/D,YAAY,CAAC,KAAK,CAAC,EAAC,WAAY,CAAC,EAAC,CAAC,CAAC;;AAGpC,MAAM,CAAC,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC,QAAQ,EAAE,YAAY,CAAC,CAAC","file":"src/api/device/deModel.js","sourcesContent":["var mongoose        = require('mongoose');\nvar async = require('async');\nvar MOMENT    = require('../moment/moModel');\nvar PUBNUB = require('../service/pubnub');\nvar LOG = require('../service/util').logger;;\n\nvar Schema          = mongoose.Schema;\n\n\nvar FriendScheme = new Schema(\n    {\n        device_id:String,\n        channel_id:String,\n        nick_name:String,\n        moments:[{\n            image_url:String,\n            status:String,\n            timestamp: { type: Date, default: Date.now },\n        }],\n        timestamp: { type: Date, default: Date.now },\n    }, { _id: false});\n\nvar Subscribes = new Schema(\n    {\n        channel_id:String,\n        nick_name:String,\n        moments:[{\n            image_url:String,\n            status:String,\n            timestamp: { type: Date, default: Date.now },\n        }],\n        timestamp: { type: Date, default: Date.now },\n    }, { _id: false});\n\nvar fansSchema = new Schema(\n    {\n        channel_id:String,\n        uuid:String,\n    }, { _id: false});\n\nvar DeviceSchema   = new Schema(\n    {\n        device_id: String,\n        channel_uuid: String,\n        pubnub_key: String,\n        moments: [MOMENT.schema],\n        friends: [FriendScheme],\n        subscribes:[Subscribes],\n        fans: [fansSchema],\n        timestamp       : { type: Date, default: Date.now }\n    });\n\n/*\n* Middleware\n*/\nDeviceSchema.statics.getDevice = function( req, res, next)\n{\n    LOG.info('[ Middleware ] getDevice');\n    LOG.info(req.body.auth_token);\n    LOG.info(req.body.auth_token.device_id);\n\n    mongoose.model('Device').findOne(\n        {\n           'device_id' : req.body.auth_token.device_id\n        },\n        function ( err, device )\n            {\n                if(err)\n                {\n                    res.status(404).json({err:err});\n                }else{\n                    req.body.resource_device = device;\n                    next();\n                }\n\n            });\n};\nDeviceSchema.statics.addSubscriber = function(target, own_server_channel_id, nickname,next){\n\n\n         mongoose.model( 'Device' ).update(\n            {\n               'device_id' :target.did\n            },\n            {\n                $addToSet :\n                {\n                    fans :\n                    {\n                        'channel_id' : own_server_channel_id,\n                        'uuid'       : target.uuid\n                    }\n                }\n            },\n            function(err,num, obj){\n                if(next) next( err, num, obj );\n                LOG.error('#######################################################################');\n                            LOG.info(err);\n                            LOG.info(num);\n                            LOG.info(obj);\n            });\n}\nDeviceSchema.statics.notifySubscriber = function(mo){\n    console.log('notifySubscriber');\n    mongoose.model('Device').find(\n    {\n        'device_id':mo.device_id\n    },{\n        'fans':1\n    },(err, fans)=>{\n        console.log('notifyremote');\n        console.log(mo);\n        console.log(fans[0]);\n        console.log(fans[0].fans);\n\n        async.each(fans[0].fans,(f, callback)=>{\n            console.log('f@@@@@@@@@@@@@@@@@@@');\n            console.log(f);\n            PUBNUB.notifyRemote({\n                type:'subscription',\n                server_channel_id:f.channel_id,\n                uuid:f.uuid,\n                image_url:mo.image_url,\n                status: mo.status\n            });\n\n        });\n\n    });\n}\nDeviceSchema.statics.saveFriend = function( did, frdObj )\n{\n    mongoose.model('Device').findOne(\n        {\n           'device_id' : did,\n        },\n        function ( err, device )\n        {\n            device.update(\n                {\n                    $addToSet :\n                    {\n                        friends : frdObj\n                    }\n                });\n        });\n};\n\nDeviceSchema.statics.filterFriends = function(device, next)\n{\n    async.filter(device.friends, function(friend)\n            {\n                return (friend)?{}: {\n                        nick_name: friend.nick_name,\n                        channel_id : friend.channel_id,\n                        moments : friend.moments,\n                        timestamp: friend.timestamp,\n                    }\n            },\n            function(friend_list)\n            {\n\n                next();\n            });\n};\n\nDeviceSchema.methods.getCurrentMoment = function(next)\n{\n    return this.moments[0];\n};\n\n\nDeviceSchema.index({'moments.mid':1});\nDeviceSchema.index({'moments.mid':1, 'moments.explore.mid':1});\nDeviceSchema.index({'device_id':1});\n\n\nmodule.exports = mongoose.model('Device', DeviceSchema);\n\n"]}